name: Tests
on:
  push:

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  CUDA:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    container: ghcr.io/ggeorgakoudis/boutdev-cuda:latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build minimal CUDA 12.2 @ GCC9.4.0 @ Ubuntu 20.04
        run: |
          . /spack/share/spack/setup-env.sh
          spack env activate -p /spack-env
          git config --global --add safe.directory $GITHUB_WORKSPACE
          rm -rf build
          cmake -S $GITHUB_WORKSPACE -B build \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++ \
            -DBOUT_ENABLE_RAJA=on \
            -DBOUT_ENABLE_UMPIRE=on \
            -DBOUT_ENABLE_CUDA=on \
            -DCMAKE_CUDA_ARCHITECTURES=80 \
            -DCUDA_ARCH=compute_80,code=sm_80 \
            -DBOUT_ENABLE_WARNINGS=on \
            -DBOUT_USE_SYSTEM_FMT=on
          echo "------------"
          cat build/include/bout/build_defines.hxx
          echo "------------"
          cmake --build build --verbose
